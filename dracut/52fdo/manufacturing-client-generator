#!/bin/bash
# -*- mode: shell-script; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# ex: ts=8 sw=4 sts=4 et filetype=sh

command -v getarg >/dev/null || . /usr/lib/dracut-lib.sh

set -e

# Generators don't have logging right now
# https://github.com/systemd/systemd/issues/15638
exec 1>/dev/kmsg; exec 2>&1

manufacturing_service_url=$(getarg fdo.manufacturing_server_url= ||:)
cat >"/etc/manufacturing-client-config" <<EOF
# Automatically generated by live-generator
MANUFACTURING_SERVER_URL="${manufacturing_server_url}"
DIUN_PUB_KEY_INSECURE="true" # this has to be configurable as well
# TODO(runcom):
# DIUN_PUB_KEY_HASH
# DIUN_PUB_KEY_ROOTCERTS <- this is a known path where osbuild-composer writes the cert to
EOF
fi